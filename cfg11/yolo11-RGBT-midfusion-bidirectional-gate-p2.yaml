# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license

# Ultralytics YOLO11 + BidirectionalGate P2 Early Fusion
# åœ¨ P2 å±‚ (1/4 åˆ†è¾¨ç‡) è¿›è¡ŒåŒå‘é—¨æ§èåˆ

# Parameters
nc: 80
scales:
  n: [0.50, 0.25, 1024]
  s: [0.50, 0.50, 1024]
  m: [0.50, 1.00, 512]
  l:  [1.00, 1.00, 512]
  x:  [1.00, 1.50, 512]

ch: 4

backbone:
  - [-1, 1, Silence, []]  # 0

  # ========== Visible åˆ†æ”¯ ==========
  - [0, 1, SilenceChannel, [0, 3]]     # 1
  - [-1, 1, Conv, [64, 3, 2]]          # 2  P1/2
  - [-1, 1, Conv, [128, 3, 2]]         # 3  P2/4
  - [-1, 2, C3k2, [256, False, 0.25]]  # 4  Visible P2 ç‰¹å¾ â­

  # ========== Infrared åˆ†æ”¯ ==========
  - [0, 1, SilenceChannel, [3, 4]]     # 5
  - [-1, 1, Conv, [64, 3, 2]]          # 6  P1/2
  - [-1, 1, Conv, [128, 3, 2]]         # 7  P2/4
  - [-1, 2, C3k2, [256, False, 0.25]]  # 8  Infrared P2 ç‰¹å¾ â­

  # ========== P2 åŒå‘é—¨æ§èåˆ ==========
  - [[4, 8], 1, BidirectionalGate, [16]]   # 9  è¾“å‡º [vis_out, ir_out]
  - [9, 1, GateSelector, [0]]              # 10 é€‰æ‹©å¢å¼ºçš„ Visible
  - [9, 1, GateSelector, [1]]              # 11 é€‰æ‹©å¢å¼ºçš„ Infrared

  # ========== P2 æœ€ç»ˆèåˆ ==========
  - [[10, 11], 1, ADD, []]             # 12 P2 èåˆ â­

  # ========== å•æµç»§ç»­ (P3 â†’ P5) ==========
  - [-1, 1, Conv, [256, 3, 2]]         # 13 P3/8
  - [-1, 2, C3k2, [512, False, 0.25]]  # 14 P3 ç‰¹å¾

  - [-1, 1, Conv, [512, 3, 2]]         # 15 P4/16
  - [-1, 2, C3k2, [512, True]]         # 16 P4 ç‰¹å¾

  - [-1, 1, Conv, [1024, 3, 2]]        # 17 P5/32
  - [-1, 2, C3k2, [1024, True]]        # 18
  - [-1, 1, SPPF, [1024, 5]]           # 19
  - [-1, 2, C2PSA, [1024]]             # 20 P5 ç‰¹å¾

head:
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]
  - [[-1, 16], 1, Concat, [1]]         # cat P4
  - [-1, 2, C3k2, [512, False]]        # 23

  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]
  - [[-1, 14], 1, Concat, [1]]         # cat P3
  - [-1, 2, C3k2, [256, False]]        # 26 (P3/8-small)

  - [-1, 1, Conv, [256, 3, 2]]
  - [[-1, 23], 1, Concat, [1]]
  - [-1, 2, C3k2, [512, False]]        # 29 (P4/16-medium)

  - [-1, 1, Conv, [512, 3, 2]]
  - [[-1, 20], 1, Concat, [1]]
  - [-1, 2, C3k2, [1024, True]]        # 32 (P5/32-large)

  - [[26, 29, 32], 1, Detect, [nc]]    # Detect(P3, P4, P5)